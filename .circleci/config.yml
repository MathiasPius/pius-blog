version: 2

jobs:
  "build debug":
    docker:
      - image: frolvlad/alpine-rust:latest

    steps:
      - checkout
      - restore_cache:
          key: debug-cache
      - run:
            name: Build
            command: cargo build
      - save_cache:
          key: debug-cache
          paths:
            - "~/.cargo"
            - "./target"

  "build release":
    docker:
      - image: frolvlad/alpine-rust:latest

    steps:
      - checkout
      - restore_cache:
          key: release-cache
      - run:
            name: Build
            command: cargo build --release
      - save_cache:
          key: release-cache
          paths:
            - "~/.cargo"
            - "./target"

  "store debug artifacts":
    docker:
      - image: frolvlad/alpine-rust:latest

    steps:
      - checkout
      - run: |
          mkdir artifacts/
          cp -R ./templates ./artifacts/
      - restore_cache:
          key: debug-cache
      - run: |
          cp -R ./target/debug/blog ./artifacts/
          tar c -zf debug.tar.gz ./artifacts/*
      - store_artifacts:
          path: ./debug.tar.gz
          destination: debug-artifact.tar.gz

  "store release artifacts":
    docker:
      - image: frolvlad/alpine-rust:latest

    steps:
      - checkout
      - run: |
          mkdir artifacts/
          cp -R ./templates ./artifacts/
      - restore_cache:
          key: release-cache
      - run: |
          cp -R ./target/release/blog ./artifacts/
          tar c -zf release.tar.gz ./artifacts/*
      - store_artifacts:
          path: ./release.tar.gz
          destination: release-artifact.tar.gz

workflows:
  version: 2
  build:
    jobs:
      - build debug
      - build release
      - store debug artifacts:
          requires:
            - build debug

      - store release artifacts:
          requires:
            - build release
        
